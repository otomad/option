<html>

<head>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<meta name="keywords" content="彩虹文字生成器, 彩虹字生成器, 彩虹字转换器, 彩虹字UBB代码生成器, 彩虹字Html代码生成器">
	<link rel="shortcut icon" href="./favicon.png">
	<link rel="bookmark" href="./favicon.png">
	<title>彩虹文字生成器</title>
	<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.5.0/font/bootstrap-icons.css" />
	<link rel="stylesheet" href="https://bootswatch.com/_vendor/bootstrap/dist/css/bootstrap.min.css">
	<link id="css" data-theme="bootstrap" rel="stylesheet" crossorigin="anonymous">
	<link rel="stylesheet" href="/basis/css/bootstrap-init.css">
	<link href="./css/index.css" rel="stylesheet">
	<script src="https://cdn.staticfile.org/jquery/3.6.0/jquery.min.js"></script>
	<script src="https://cdn.staticfile.org/twitter-bootstrap/5.0.2/js/bootstrap.bundle.min.js"></script>
	<script src="./js/jqColorPicker.min.js"></script>
	<script src="./js/clipboard.min.js"></script>
	<script src="../content-info.js"></script>
	<style>
		
	</style>
</head>

<body>
	<div class="container-fluid">
		<div class="row-fluid">
			<div id="main-body" class="main">
				<h1 class="page-header clearfix mb-4">
					<span>
						<font color="#FF2800">彩</font><font color="#FF5000">虹</font><font color="#FF7800">文</font><font color="#FFA000">字</font><font color="#FFC800">生</font><font color="#FFF000">成</font><font color="#D7FF00">器</font>
					</span>
					<!-- <button type="button" class="btn btn-outline-secondary btn-sm reset-on-right-float" id="reset" style="padding:.25rem .75rem;display:inline-block;float:right;margin:11 0;">重设</button> -->
				</h1>
				<div class="row">
					<div class="col-lg-4">
						<div class="input-group mb-3">
							<label class="input-group-text input-group-addon" for="text-str">生成文字</label><br />
								<button class="btn btn-outline-secondary btn-sm sm" type="button" id="reset" data-bs-placement="bottom" title="重设" data-bs-toggle="tooltip">
									<i class="bi bi-arrow-counterclockwise" style="margin: 0;"></i>
								</button>
							<div id="text-str" class="form-control" rows="3" style="min-height:125px" autofocus placeholder="请在这里填写需要生成的文字内容" contenteditable="true"></div>
						</div>
						<div class="input-group mb-3">
							<label class="input-group-text input-group-addon">设定格式</label>
							<div class="form-control format-form-control">
								<div class="btn-group format-btn-group" role="group">
									<button type="button" class="btn btn-outline-secondary" data-format="bold" title="加粗" data-bs-toggle="tooltip" data-bs-placement="bottom">
										<i class="bi bi-type-bold"></i>
									</button>
									<button type="button" class="btn btn-outline-secondary" data-format="italic" title="倾斜" data-bs-toggle="tooltip" data-bs-placement="bottom">
										<i class="bi bi-type-italic"></i>
									</button>
									<button type="button" class="btn btn-outline-secondary" data-format="underline" title="下划线" data-bs-toggle="tooltip" data-bs-placement="bottom">
										<i class="bi bi-type-underline"></i>
									</button>
									<button type="button" class="btn btn-outline-secondary" data-format="strikeThrough" title="删除线" data-bs-toggle="tooltip" data-bs-placement="bottom">
										<i class="bi bi-type-strikethrough"></i>
									</button>
								</div>
								<p style="flex-shrink: 0; margin-bottom: 0; display: grid; place-self: center;">字号</p>
								<select class="form-select" data-format="fontSize">
									<option value="1"><font size="1">12</font></option>
									<option value="2"><font size="2">13</font></option>
									<option value="3" selected><font size="3">16</font></option>
									<option value="4"><font size="4">18</font></option>
									<option value="5"><font size="5">24</font></option>
									<option value="6"><font size="6">32</font></option>
									<option value="7"><font size="7">48</font></option>
								</select>
							</div>
						</div>
						<div class="input-group mb-3">
							<label class="input-group-text input-group-addon">预设颜色</label>
							<div class="form-control" id="preset-colors" style="height:inherit">
								<div class="form-check">
									<input class="form-check-input rainbow" id="win_rainbow_style0" type="radio" checked="" value="radiobutton" name="win-rainbow-style">
									<label class="form-check-label rainbow" for="win_rainbow_style0">彩虹七色固定</label>
								</div>
								<div class="form-check">
									<input class="form-check-input rainbow" id="win_rainbow_style1" type="radio" checked="" value="radiobutton" name="win-rainbow-style">
									<label class="form-check-label" for="win_rainbow_style1" style="--fg: #FF2800; --bg: #FFC800;">彩虹七色循环</label>
								</div>
								<div class="form-check" data-fg-color="#000000" data-bg-color="#FFFFFF">
									<input class="form-check-input" id="win_rainbow_style2" type="radio" value="radiobutton" name="win-rainbow-style">
									<label class="form-check-label" for="win_rainbow_style2" style="--fg: #555555; --bg: #AAAAAA;">黑白</label>
								</div>
								<div class="form-check" data-fg-color="#001D24" data-bg-color="#FF1D24">
									<input class="form-check-input" id="win_rainbow_style3" type="radio" value="radiobutton" name="win-rainbow-style">
									<label class="form-check-label" for="win_rainbow_style3" style="--fg: #7F1D24; --bg: #FF1D24;">黑红</label>
								</div>
								<div class="form-check" data-fg-color="#00AEFF" data-bg-color="#00AE00">
									<input class="form-check-input" id="win_rainbow_style4" type="radio" value="radiobutton" name="win-rainbow-style">
									<label class="form-check-label" for="win_rainbow_style4" style="--fg: #00AEFF; --bg: #00AE00;">蓝绿</label>
								</div>
								<div class="form-check">
									<input class="form-check-input" id="win_rainbow_style5" type="radio" value="radiobutton" name="win-rainbow-style">
									<label class="form-check-label" for="win_rainbow_style5" style="--fg: #0000FF; --bg: #FF0000;">自定义</label>
								</div>
							</div>
						</div>
						<div class="input-group mb-3">
							<label class="input-group-text input-group-addon" id="view-color-tag">预览颜色</label>
							<div class="form-control view-color" style="padding:0;height:inherit">
								<span id="color-picker">
									<input id="text-fore-color" class="form-control color choose-color" value="#0000FF" style="float:left ;width:50%" disabled="">
									<input id="text-back-color" class="form-control color choose-color" value="#FF0000" style="float:right;width:50%;text-align:right" disabled="">
								</span>
								<div class="form-control cover-color" id="linear5" style="background-color: #222222"></div>
								<div class="form-control cover-color" id="linear4" style="background-image: linear-gradient(to right, #00AEFF, #00AE00)"></div>
								<div class="form-control cover-color" id="linear3" style="background-image: linear-gradient(to right, #001D24, #FF1D24)"></div>
								<div class="form-control cover-color" id="linear2" style="background-image: linear-gradient(to right, black, white)"></div>
								<div class="form-control cover-color" id="linear1" style="background-image: linear-gradient(to right, red, yellow, lime, cyan, blue, magenta, red)"></div>
							</div>
						</div>
						<div class="input-group mb-3">
							<label class="input-group-text input-group-addon" id="sizing-addon3" for="select-type">代码类型</label>
							<select class="form-select" id="select-type">
								<option value="ubb">BBCode (UBB)（论坛）</option>
								<option value="html" selected>HTML（网页）</option>
							</select>
						</div>
						<div class="d-grid"><button type="button" class="btn btn-primary btn-block mb-3" id="preview">生成</button></div>
					</div>
					<div class="col-lg-8">
						<div class="row">
							<div class="col-xl-6">
								<div class="card" id="row-view">
									<div class="card-body">
										<h5 class="card-title" id="viewCardName">生成后在此处预览</h5>
										<p class="card-content" id="panel-preview"></p>
									</div>
								</div>
							</div>
							<div class="col-xl-6">
								<div class="card mb-2" id="row-html">
									<div class="card-body" id="panel-html">
										<table class="card-html-table">
											<td><h5 class="card-title">代码</h5></td>
											<td style="text-align:right;padding-bottom:12px"><a href="javascript:void(0);" id="copy-code" style="text-decoration:none" data-clipboard-action="copy" data-clipboard-target="#xmp-html" title="复制到剪贴板" data-toggle="tooltip">复制代码</a></td>
										</table>
										<pre><code class="card-content" id="xmp-html" style="white-space: normal; word-break: break-all;"></code></pre>
									</div>
								</div>
							</div>
						</div>
					</div>
				</div>
				<content-info>
					<p>彩虹文字生成器<small>（不是彩虹屁文字生成器）</small>，这个在线工具可以将你输入的文字转换成颜色线性渐变过渡的效果，输出的文字色彩就如同彩虹一般缤纷绚丽，故取名为“彩虹字”。</p>
					<p>输出的代码中的每一个字都被加上了一段颜色代码，正是这些代码使得文字在网页上呈现出颜色渐变过渡效果。本工具默认生成的是<b>HTML</b> (<b>H</b>yper<b>T</b>ext <b>M</b>arkup <b>L</b>anguage)代码，它在网页中具有更广泛的支持。你也可以手动选择输出<b>BBCode</b> (<b>B</b>ulletin <b>B</b>oard <b>Code</b>)代码，也被称为安全代码，这种代码通常在论坛、博客、网络社区、留言板等都可以获得较好的支持。BBCode最初由<b>U</b>ltimate <b>B</b>ulletin <b>B</b>oard讨论区系统发展出来，因此常见<b>UBB代码</b>的称呼。</p>
					<p>彩虹字可以使文字更醒目、更好看。不过由于彩虹字的代码量较多，故不宜对字数过多的文章进行全篇生成，实际上对一篇文章中的部分文字彩虹化更合适宜。</p>
					<p>彩虹文字生成器使用说明：</p>
					<p>在文本框中输入需要转换的文字，然后选择你喜欢的过渡颜色，然后点击“生成”按钮即可输出对应的预览效果，同时在下方输出代码，满意后即可复制代码粘贴到需要的地方。如果对输出的效果不满意，则改变色彩样式后再重新生成。</p>
				</content-info>
				<br />
				<script src="/basis/Color.js" type="module"></script>
				<script>
					var NightTime = {};
					NightTime.darkDo = NightTime.lightDo = () => {
						const action = () => $(".format-form-control select").css("color", $(".btn-outline-secondary").css("color"));
						action();
						setTimeout(action, 500);
					};
					
					var clipboard = new ClipboardJS("#copy-code");
					$("#copy-code").click(function () {
						clipboardReact("已复制");
					});
					function clipboardReact(title) {
						var clipbtn = $("#copy-code");
						clipbtn.focus();
						clipbtn.attr("title", title).tooltip("_fixTitle").tooltip("show");
						setTimeout(function () {
							clipbtn.attr("title", "复制到剪贴板").tooltip("_fixTitle");
							clipbtn.mouseout(function () {
								clipbtn.tooltip("hide");
							});
						}, 500);
					}

					window.onresize = function () {
						if (haveText) cardResize();
					}

					$(document).ready(function () {
						$('[data-bs-toggle="tooltip"]').tooltip();
					});

					$(function () {
						wrStyle(1);
						$(".color").colorPicker({ opacity: false });
					});

					$("#reset").click(function () {
						$("#text-str").text("");
						$("#text-str").focus();
						$("#text-str").select();
						updateFormatButtonsSelected();
					});

					var haveText = false,
						fgColor = $("#text-fore-color").val(),
						bgColor = $("#text-back-color").val();
					$("#preview").click(function () {
						$("#viewCardName")[0].innerHTML = "生成后在此处预览";
						$("#row-view").css("height", "68px");
						$("#row-html").css({
							"height": "0",
							"border": "0px solid rgba(0,0,0,.125)"
						});
						$(".card").css("margin-bottom", "0");
						$(".card-content").css({
							"opacity": "0",
							"user-select": "none"
						});
						haveText = false;

						const str = $("#text-str").text();
						fgColor = $("#text-fore-color").val();
						bgColor = $("#text-back-color").val();
						const type = $("#select-type").val();

						if (str == "") {
							$("#text-str").select();
							errorValue("#text-str");
						}

						if (typeof str == "undefined" || str == null || str == "") {
							$("#alert-message").html("请填写需要生成的文字内容");
							$("#row-alert").show();
							return false;
						} else if (!(/(^#[0-9A-F]{6}$)|(^#[0-9A-F]{3}$)/i.test(fgColor))) {
							$("#alert-message").html("请填写正确的开始颜色代码");
							$("#row-alert").show();
							return false;
						} else if (!(/(^#[0-9A-F]{6}$)|(^#[0-9A-F]{3}$)/i.test(bgColor))) {
							$("#alert-message").html("请填写正确的结束颜色代码");
							$("#row-alert").show();
							return false;
						} else {
							$("#row-alert").hide();
							let ubb = "", html = "";
							const texts = walkTextStr();
							for (const [i, line] of texts.entries()) {
								if (i) {
									ubb += "\n";
									html += "<br />\n";
								}
								let startLengths = [0], totalLength = 0;
								for (const [j, format] of line.entries()) {
									const length = format.text.length;
									totalLength += length;
									startLengths[j + 1] = totalLength;
								}
								for (const [j, format] of line.entries()) {
									// const plain = set_rainbow(format.text, fgColor.replace("#", ""), bgColor.replace("#", ""), type);
									const plain = setRainbow(format.text, startLengths[j], totalLength);
									const rich = addFormatToCode(plain, format);
									ubb += rich.ubb;
									html += rich.html;
								}
							}
							setTextWithLineBreak($("#xmp-html"), type === "ubb" ? ubb : html);
							$("#panel-preview").html(html);
							
							$("#viewCardName")[0].innerHTML = "预览";
							cardResize();
							setTimeout(() => cardResize(), 500);
							$("#row-html").css("border", "1px solid rgba(0,0,0,.125)");
							$(".card").css("margin-bottom", "1rem");
							$(".card-content").css({
								"opacity": "1",
								"user-select": "text"
							});
							haveText = true;
						}
					});

					function cardResize() {
						var row2 = ["#row-view", "#row-html"];
						for (var i = 0; i < 2; i++) {
							var el = $(row2[i]),
								curHeight = el.height(),
								autoHeight = el.css("height", "auto").height();
							el.height(curHeight).animate({
								height: autoHeight
							}, 250);
						}
					}

					function errorValue(element) {
						$(element).addClass("is-invalid");
						setTimeout(function () {
							$(element).removeClass("is-invalid");
						}, 2000);
					}

					var interval = 0;
					$(".choose-color").focus(function () {
						interval = setInterval(() => wrStyle(5), 10 /* 150 */);
					});
					$(".choose-color").blur(function () {
						clearInterval(interval);
						var color2 = ["#text-fore-color", "#text-back-color"];

						function colorNaNDo(i) {
							$(color2[i]).val("#000000");
							wrStyle(5);
						}
						for (var i = 0; i < 2; i++) {
							if ($(color2[i]).val().search("N") != -1) {
								setTimeout(colorNaNDo, 250, i);
								errorValue(".view-color");
							}
						}
					});
					
					/**
					 * @param {string[]} text - 被设定格式分割后的文本片段。
					 * @param {number} startLength - 该文本片段的首个字符在整段文本的第几个。
					 * @param {number} totalLength - 整段文本的字符数。
					 */
					function setRainbow(text, startLength, totalLength) {
						totalLength--;
						text = Array.from(text);
						const checked = $("input[name=win-rainbow-style]:checked");
						if (!checked.length) return;
						/** @type {{ char: string; color: string; }[]} */
						const code = [];
						const appendChar = (char, color) => code.push({ char, color });
						const isWhiteSpace = text => text.trim().length === 0;
						const id = +checked[0].id.match(/\d+$/)[0];
						if (id !== 1) {
							if (!checked.hasClass("rainbow")) {
								let { fgColor, bgColor } = checked.parent()[0].dataset;
								fgColor = Color.fromHex(fgColor);
								bgColor = Color.fromHex(bgColor);
								const { r: r1, g: g1, b: b1 } = fgColor.rgb;
								const { r: r2, g: g2, b: b2 } = bgColor.rgb;
								text.forEach((char, i) => {
									if (!isWhiteSpace(char)) {
										const
											r = (r2 - r1) / totalLength * (startLength + i) + r1,
											g = (g2 - g1) / totalLength * (startLength + i) + g1,
											b = (b2 - b1) / totalLength * (startLength + i) + b1;
										appendChar(char, Color.fromRgb(r, g, b).hex);
									} else appendChar(char);
								});
							} else {
								text.forEach((char, i) => {
									if (!isWhiteSpace(char)) {
										const hue = 360 / totalLength * (startLength + i);
										appendChar(char, Color.fromHsv(hue, 100, 100).hex);
									} else appendChar(char);
								});
							}
						} else {
							const step = Color.fromHex("#ff2800").h;
							text.forEach((char, i) => {
								if (!isWhiteSpace(char)) {
									const hue = (startLength + i) * step;
									appendChar(char, Color.fromHsv(hue, 100, 100).hex);
								} else appendChar(char);
							});
						}
						let ubb = "", html = "";
						for (const { char, color } of code) {
							if (!color) {
								ubb += char;
								html += char;
							} else {
								ubb += `[color=#${color}]${char}[/color]`;
								html += `<font color="#${color}">${char}</font>`;
							}
						}
						return { ubb, html };
					}

					/**
					 * @deprecated
					 */
					function set_rainbow(wr_text, wr_rgb1, wr_rgb2) { //设置彩虹文字
						var wr_rgb, r, g, b, i, j, istep;
						var r1, g1, b1, r2, g2, b2;
						r1 = g1 = b1 = r2 = g2 = b2 = 0;
						r = 0;
						g = 0;
						b = 0;
						istep = 0;
						wr_text = Array.from(wr_text);
						/** @type {{ char: string; color: string; }[]} */
						const wr_code = [];
						const appendChar = (char, color) => wr_code.push({ char, color });
						const isWhiteSpace = text => text.trim().length === 0;

						if (win_rainbow_style1.checked) {
							istep = 40;
							r = 255;
							i = 1;
							j = 0;
							do {
								if (!isWhiteSpace(wr_text[j])) { // wr_text.charCodeAt(j) != 32
									if (g + istep < 256) {
										if (i == 1) g += istep;
									} else if (i == 1) {
										i = 2;
										g = 255;
									}
									if (r - istep > -1) {
										if (i == 2) r -= istep;
									} else if (i == 2) {
										i = 3;
										r = 0;
									}
									if (b + istep < 256) {
										if (i == 3) b += istep;
									} else if (i == 3) {
										i = 4;
										b = 255;
									}
									if (g - istep > -1) {
										if (i == 4) g -= istep;
									} else if (i == 4) {
										i = 5;
										g = 0;
									}
									if (r + istep < 256) {
										if (i == 5) r += istep;
									} else if (i == 5) {
										i = 6;
										r = 255;
									}
									if (b - istep > -1) {
										if (i == 6) b -= istep;
									} else if (i == 6) {
										i = 1;
										b = 0;
									}
									wr_rgb = "";
									wr_rgb += parseInt(r).toString(16).length == 1 ? 0 + parseInt(r).toString(16) : parseInt(r).toString(16);
									wr_rgb += parseInt(g).toString(16).length == 1 ? 0 + parseInt(g).toString(16) : parseInt(g).toString(16);
									wr_rgb += parseInt(b).toString(16).length == 1 ? 0 + parseInt(b).toString(16) : parseInt(b).toString(16);
									wr_rgb = wr_rgb.toUpperCase();
									appendChar(wr_text[j], wr_rgb);
								} else {
									appendChar(wr_text[j]);
								}
								j++;
							} while (j < wr_text.length);
						} else if (win_rainbow_style2.checked) {
							istep = 255 / wr_text.length;
							for (i = 0; i < wr_text.length; i++) {
								if (!isWhiteSpace(wr_text[i])) {
									r += istep;
									g += istep;
									b += istep;
									if (r > 255) r = 255;
									if (g > 255) g = 255;
									if (b > 255) b = 255;
									wr_rgb = "";
									wr_rgb += parseInt(r).toString(16).length == 1 ? 0 + parseInt(r).toString(16) : parseInt(r).toString(16);
									wr_rgb += parseInt(g).toString(16).length == 1 ? 0 + parseInt(g).toString(16) : parseInt(g).toString(16);
									wr_rgb += parseInt(b).toString(16).length == 1 ? 0 + parseInt(b).toString(16) : parseInt(b).toString(16);
									wr_rgb = wr_rgb.toUpperCase();
									appendChar(wr_text[i], wr_rgb);
								} else {
									appendChar(wr_text[i]);
								}
							}
						} else if (win_rainbow_style3.checked) {
							istep = 255 / wr_text.length;
							for (i = 0; i < wr_text.length; i++) {
								if (!isWhiteSpace(wr_text[i])) {
									r += istep;
									g = 29;
									b = 36;
									if (r > 255) r = 255;
									if (g > 255) g = 255;
									if (b > 255) b = 255;
									wr_rgb = "";
									wr_rgb += parseInt(r).toString(16).length == 1 ? 0 + parseInt(r).toString(16) : parseInt(r).toString(16);
									wr_rgb += parseInt(g).toString(16).length == 1 ? 0 + parseInt(g).toString(16) : parseInt(g).toString(16);
									wr_rgb += parseInt(b).toString(16).length == 1 ? 0 + parseInt(b).toString(16) : parseInt(b).toString(16);
									wr_rgb = wr_rgb.toUpperCase();
									appendChar(wr_text[i], wr_rgb);
								} else {
									appendChar(wr_text[i]);
								}
							}
						} else if (win_rainbow_style4.checked) {
							istep = 255 / wr_text.length;
							for (i = 0; i < wr_text.length; i++) {
								if (!isWhiteSpace(wr_text[i])) {
									r = 0;
									g = 174;
									b += istep;
									if (r > 255) r = 255;
									if (g > 255) g = 255;
									if (b > 255) b = 255;
									wr_rgb = "";
									wr_rgb += parseInt(r).toString(16).length == 1 ? 0 + parseInt(r).toString(16) : parseInt(r).toString(16);
									wr_rgb += parseInt(g).toString(16).length == 1 ? 0 + parseInt(g).toString(16) : parseInt(g).toString(16);
									wr_rgb += parseInt(255 - b).toString(16).length == 1 ? 0 + parseInt(255 - b).toString(16) : parseInt(255 - b).toString(16);
									wr_rgb = wr_rgb.toUpperCase();
									appendChar(wr_text[i], wr_rgb);
								} else {
									appendChar(wr_text[i]);
								}
							}
						} else if (win_rainbow_style5.checked) {
							r1 = parseInt("0x" + String(wr_rgb1).substr(0, 2));
							g1 = parseInt("0x" + String(wr_rgb1).substr(2, 2));
							b1 = parseInt("0x" + String(wr_rgb1).substr(4, 2));
							r2 = parseInt("0x" + String(wr_rgb2).substr(0, 2));
							g2 = parseInt("0x" + String(wr_rgb2).substr(2, 2));
							b2 = parseInt("0x" + String(wr_rgb2).substr(4, 2));
							if (isNaN(r1)) r1 = 0;
							if (isNaN(g1)) g1 = 0;
							if (isNaN(b1)) b1 = 0;
							if (isNaN(r2)) r2 = 0;
							if (isNaN(g2)) g2 = 0;
							if (isNaN(b2)) b2 = 0;
							istep = 255 / wr_text.length;
							for (i = 0; i < wr_text.length; i++) {
								if (!isWhiteSpace(wr_text[i])) {
									wr_rgb = "";
									wr_rgb += parseInt(r1).toString(16).length == 1 ? 0 + parseInt(r1).toString(16) : parseInt(r1).toString(16);
									wr_rgb += parseInt(g1).toString(16).length == 1 ? 0 + parseInt(g1).toString(16) : parseInt(g1).toString(16);
									wr_rgb += parseInt(b1).toString(16).length == 1 ? 0 + parseInt(b1).toString(16) : parseInt(b1).toString(16);
									wr_rgb = wr_rgb.toUpperCase();
									appendChar(wr_text[i], wr_rgb);
									r1 > r2 ? r1 -= istep : r1 += istep;
									g1 > g2 ? g1 -= istep : g1 += istep;
									b1 > b2 ? b1 -= istep : b1 += istep;
									if (r1 > 255) r1 = 255;
									if (r1 < 0) r1 = 0;
									if (g1 > 255) g1 = 255;
									if (g1 < 0) g1 = 0;
									if (b1 > 255) b1 = 255;
									if (b1 < 0) b1 = 0;
								} else {
									appendChar(wr_text[i]);
								}
							}
						}
						let ubb = "", html = "";
						for (const { char, color } of wr_code) {
							if (!color) {
								ubb += char;
								html += char;
							} else {
								ubb += `[color=#${color}]${char}[/color]`;
								html += `<font color="#${color}">${char}</font>`;
							}
						}
						return { ubb, html };
					}
					
					$("#preset-colors .form-check").click(function () {
						$(this).find("input:radio").prop("checked", true).change().focus();
					});
					
					$("#preset-colors input:radio").change(function () {
						wrStyle(+this.id.match(/\d+$/)[0]);
					});

					function wrStyle(num) {
						fgColor = $("#text-fore-color").val();
						bgColor = $("#text-back-color").val();
						var view = $(".view-color");
						if (num < 5) linearHide(num);
						else {
							$("#color-picker").css("opacity", "1");
							view.css("background-image", `linear-gradient(to right, ${fgColor}, ${bgColor})`);
							const { dataset } = $("[for=win_rainbow_style5]").css({ "--fg": fgColor, "--bg": bgColor }).parent()[0];
							Object.assign(dataset, { fgColor, bgColor });
							for (var i = 1; i <= 5; i++)
								$("#linear" + i).css("opacity", "0");
							setTimeout(function () {
								for (var i = 1; i <= 5; i++)
									$("#linear" + i).css("display", "none");
							}, 250);
							$("#view-color-tag")[0].innerHTML = "设定颜色";
							$(".choose-color").css("opacity", "1");
						}
						const textColor = $("#text-fore-color, #text-back-color");
						if (num === 5) textColor.removeAttr("disabled");
						else textColor.attr("disabled", "disabled");
					}

					function linearHide(id) {
						if (id === 0) id = 1;
						if ($("#linear1").is(":hidden")) {
							for (var i = 0; i <= 5; i++)
								$("#linear" + i).css("display", "");
							setTimeout(function () {
								$("#linear" + id).css("opacity", "1");
								$("#linear5").css("opacity", "1");
								$("#color-picker").css("opacity", "0");
							}, 100);
						}
						else {
							$("#linear" + id).css("opacity", "1");
							//setTimeout(function() {
							for (var i = 0; i <= 4; i++)
								if (i != id)
									$("#linear" + i).css("opacity", "0");
							$("#color-picker").css("opacity", "0");
						}
						setTimeout(function () {
							$(".view-color").css("background-image", $("#linear" + id).css("background-image"));
						}, 250);
						$("#view-color-tag")[0].innerHTML = "预览颜色";
						$(".choose-color").css("opacity", "0");
					}

					$(".cp-color-picker").click(function () {
						wrStyle(5);
					});
					
					function setFormatButtonSelected(format, selected) {
						$(`[data-format="${format}"]`).toggleClass("btn-outline-secondary", !selected).toggleClass("btn-primary", selected);
					}
					
					function updateFormatButtonsSelected() {
						for (const button of $(".format-form-control [data-format]")) {
							const format = button.dataset.format;
							if (button instanceof HTMLButtonElement) {
								const selected = document.queryCommandState(format);
								setFormatButtonSelected(format, selected);
							} else if (button instanceof HTMLSelectElement) {
								const value = document.queryCommandValue(format);
								button.value = value;
							}
						}
					}

					$(".format-btn-group .btn").click(function () {
						const format = this.dataset.format;
						$("#text-str").focus();
						document.execCommand(format);
						updateFormatButtonsSelected();
					});
					
					$(".format-form-control select").change(function () {
						const format = this.dataset.format;
						const value = this.value;
						$("#text-str").focus();
						document.execCommand(format, false, value);
						updateFormatButtonsSelected();
					});
					
					$(document).on("selectionchange input change", function () {
						if ($("#text-str")[0] !== document.activeElement) return;
						updateFormatButtonsSelected();
					});
					
					class Format {
						/** @type {string} */
						text;
						/** @type {boolean | undefined} */
						bold;
						/** @type {boolean | undefined} */
						italic;
						/** @type {boolean | undefined} */
						underline;
						/** @type {boolean | undefined} */
						strikethrough;
						/** @type {number | undefined} */
						fontSize;
						/**
						 * @param {string} text
						 * @param {Format} format
						 */
						constructor(text, format) {
							this.text = text;
							if (format) Object.assign(this, format);
						}
						/**
						 * @param {Format} options
						 */
						cloneWith(options = {}) {
							const format = new Format();
							return Object.assign(format, this, options);
						}
					}
					
					function walkTextStr() {
						const root = $("#text-str")[0];
						/** @type {Format[][]} */
						const tagged = [];
						const lines = (() => {
							/** @type {Node[][]} */
							const result = [];
							/** @type {Node[]} */
							let currentLine = [];
							const submitCurrentLine = () => {
								if (currentLine.length) {
									result.push(currentLine);
									currentLine = [];
								}
							};
							root.childNodes.forEach(node => {
								if (!(node.tagName === "DIV"))
									currentLine.push(node);
								else {
									submitCurrentLine();
									result.push([...node.childNodes]);
								}
							});
							submitCurrentLine();
							return result;
						})();
						const defaultFontSize = parseFloat(getComputedStyle(document.body).fontSize);
						
						function walk(nodes, parentFormat = new Format()) {
							/** @type {Format[]} */
							const result = [];
							for (const node of nodes) {
								if (node instanceof Comment)
									continue;
								else if (node instanceof Text && node.textContent)
									result.push(parentFormat.cloneWith({ text: node.textContent }));
								else if (node instanceof Element) {
									const style = getComputedStyle(node);
									if (node.hidden || style.display === "none") continue;
									// const isBlock = !style.display.includes("inline") && style.display !== "contents"; // 懒得做检测是否是块元素了
									result.push(...walk(node.childNodes, getFormatFromStyle(style, parentFormat)));
								}
							}
							return result;
						}
						
						/**
						 * @param {CSSStyleDeclaration} style
						 * @param {Format} parentFormat
						 */
						function getFormatFromStyle(style, parentFormat) {
							const format = parentFormat.cloneWith();
							format.bold = +style.fontWeight > 500;
							format.italic = style.fontStyle !== "normal";
							if (style.textDecorationLine === "underline") format.underline = true;
							if (style.textDecorationLine === "line-through") format.strikethrough = true;
							if (parseFloat(style.fontSize) !== defaultFontSize) format.fontSize = parseFloat(style.fontSize);
							return format;
						}
						
						lines.forEach(line => {
							tagged.push(walk(line));
						});
						
						return tagged;
					}
					
					/**
					 * @param {{ ubb: string; html: string }} param0
					 * @param {Format} format
					 */
					function addFormatToCode({ ubb, html }, format) {
						if (format.fontSize !== undefined) {
							ubb = `[style size="${format.fontSize}px"]${ubb}[/style]`;
							html = `<span style="font-size:${format.fontSize}px">${html}</span>`;
						}
						if (format.strikethrough) {
							ubb = `[s]${ubb}[/s]`;
							html = `<s>${html}</s>`;
						}
						if (format.underline) {
							ubb = `[u]${ubb}[/u]`;
							html = `<u>${html}</u>`;
						}
						if (format.italic) {
							ubb = `[i]${ubb}[/i]`;
							html = `<i>${html}</i>`;
						}
						if (format.bold) {
							ubb = `[b]${ubb}[/b]`;
							html = `<b>${html}</b>`;
						}
						return { ubb, html };
					}
					
					function setTextWithLineBreak(jq, text) {
						const dom = jq[0];
						const withBr = text.split("\n").flatMap((line, i) => i ? [document.createElement("br"), line] : line);
						dom.replaceChildren(...withBr);
						return jq;
					}
				</script>
				<!-- <script src="/basis/NightTime.js"></script> -->
			</div>
		</div>
	</div>
</body>

</html>
